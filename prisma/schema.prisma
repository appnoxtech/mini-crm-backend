generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  // PRIMARY KEY
  id Int @id @default(autoincrement())

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CORE IDENTITY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  name               String
  companyDomain      String? @unique
  companyLogo        String?
  companyDescription String?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BUSINESS INFORMATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  industry           String?
  companySize        String?
  companyLocation    String?
  companyWebsite     String?
  companySocialLinks Json?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TENANT & SAAS CONTROL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  isActive  Boolean   @default(true)
  deletedAt DateTime?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OWNERSHIP & AUDIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ownerUserId     Int?
  createdByUserId Int?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BILLING & SUBSCRIPTION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pricingTierId Int?
  billingStatus String    @default("TRIAL") // TRIAL | ACTIVE | PAST_DUE | SUSPENDED
  trialEndsAt   DateTime?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SYSTEM SETTINGS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  settings Json?
  timezone String @default("UTC")
  locale   String @default("en")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIMESTAMPS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS - OWNERSHIP
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  owner     User? @relation("CompanyOwner", fields: [ownerUserId], references: [id])
  createdBy User? @relation("CompanyCreator", fields: [createdByUserId], references: [id])

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS - USERS & IDENTITY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  users User[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS - CRM CORE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pipelines      Pipeline[]
  pipelineStages PipelineStage[]
  leads          Lead[]
  deals          Deal[]
  dealActivities DealActivity[]
  dealHistories  DealHistory[]
  leadHistories  LeadHistory[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS - CONTACTS & ORGANIZATIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  organizations Organization[]
  persons       Person[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS - PRODUCTS & LABELS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  products Product[]
  labels   Label[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS - EMAIL & COMMUNICATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  emailAccounts    EmailAccount[]
  emails           Email[]
  emailDrafts      EmailDraft[]
  emailSuggestions EmailSuggestion[]
  threadSummaries  ThreadSummary[]
  emailTrackingEvents EmailTrackingEvent[]
  emailContents       EmailContent[]
  emailSyncStates     EmailSyncState[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS - CALLS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  calls            Call[]
  callParticipants CallParticipant[]
  callRecordings   CallRecording[]
  callEvents       CallEvent[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS - CALENDAR & EVENTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  calendarEvents     CalendarEvent[]
  eventReminders     EventReminder[]
  eventShares        EventShare[]
  eventNotifications EventNotification[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS - IMPORTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  imports         Import[]
  importTemplates ImportTemplate[]
  importStagings  ImportStaging[]
  importRecords   ImportRecord[]
  importErrors    ImportError[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS - ACTIVITIES & KNOWLEDGE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  activities               Activity[]
  knowledgeBases           KnowledgeBase[]
  structuredKnowledgeBases StructuredKnowledgeBase[]
  clientProfiles           ClientProfile[]
  structuredKBVersions     StructuredKBVersion[]

  // RELATIONS - INVITATIONS & AUDIT
  invitations     UserInvitation[]
  auditLogs       AuditLog[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INDEXES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  @@index([ownerUserId])
  @@index([createdByUserId])
  @@index([isActive])
  @@index([billingStatus])
  @@index([deletedAt])
  @@index([createdAt])
  @@index([trialEndsAt])
  @@index([name])
  @@index([industry])
  // Composite indexes for common query patterns
  @@index([isActive, billingStatus])
  @@index([isActive, deletedAt])
  @@index([ownerUserId, isActive])
  @@index([billingStatus, trialEndsAt])
  @@map("companies")
}

model User {
  id Int @id @default(autoincrement())

  // â”€â”€ Core Identity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  companyId         Int
  // ğŸ”— Relation
  company           Company?        @relation(fields: [companyId], references: [id])
  ownedCompanies    Company[]       @relation("CompanyOwner")
  createdCompanies  Company[]       @relation("CompanyCreator")
  email             String          @unique
  name              String
  passwordHash      String
  profileImg        Json?
  phone             String?
  role              String?         @default("user")
  dateFormat        String?
  timezone          String?
  language          String?
  defaultCurrency   String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  generalActivities Activity[]
  calendarEvents    CalendarEvent[]
  callEvents        CallEvent[]
  assignedCalls     Call[]          @relation("CallAssigned")
  calls             Call[]
  activities        DealActivity[]
  dealHistories     DealHistory[]
  assignedDeals     Deal[]          @relation("DealAssigned")
  deals             Deal[]          @relation("DealOwner")
  emailAccounts     EmailAccount[]
  imports           Import[]
  labels            Label[]
  leads             Lead[]
  pipelines         Pipeline[]
  sentInvitations   UserInvitation[] @relation("InvitedBy")
  auditLogs         AuditLog[]

  @@map("users")
}

model Otp {
  id Int @id @default(autoincrement())

  email     String
  otp       String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("otps")
}

model EmailAccount {
  id            String       @id @default(uuid())
  userId        Int
  companyId     Int
  email         String
  provider      String
  accessToken   String?
  refreshToken  String?
  imapConfig    String?
  smtpConfig    String?
  isActive      Boolean      @default(true)
  lastSyncAt    DateTime?
  lastHistoryId String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  user          User         @relation(fields: [userId], references: [id])
  drafts        EmailDraft[]
  emails        Email[]
  company       Company      @relation(fields: [companyId], references: [id])

  @@map("email_accounts")
}

model Email {
  id               String               @id @default(uuid())
  messageId        String
  threadId         String?
  accountId        String
  companyId        Int
  from             String               @map("from_address")
  to               Json                 @map("to_addresses")
  cc               Json?                @map("cc_addresses")
  bcc              Json?                @map("bcc_addresses")
  subject          String
  body             String
  htmlBody         String?
  isRead           Boolean              @default(false)
  isIncoming       Boolean              @default(true)
  sentAt           DateTime
  receivedAt       DateTime?
  contactIds       Json?
  dealIds          Json?
  accountEntityIds Json?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  labelIds         Json?
  attachments      Json?
  uid              Int?
  folder           String?
  providerId       String?
  snippet          String?
  clicks           Int                  @default(0)
  lastClickedAt    DateTime?
  lastOpenedAt     DateTime?
  opens            Int                  @default(0)
  trackingEvents   EmailTrackingEvent[]
  account          EmailAccount         @relation(fields: [accountId], references: [id])
  company          Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  content          EmailContent         @relation(fields: [messageId, companyId], references: [messageId, companyId])

  @@unique([messageId, accountId])
  @@index([accountId, sentAt(sort: Desc)])
  @@index([companyId])
  @@map("emails")
}

model EmailTrackingEvent {
  id        String   @id @default(uuid())
  emailId   String
  companyId Int
  type      String
  ipAddress String?
  userAgent String?
  metadata  Json?
  createdAt DateTime @default(now())
  email     Email    @relation(fields: [emailId], references: [id], onDelete: Cascade)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([emailId])
  @@index([companyId])
  @@map("email_tracking_events")
}

model EmailContent {
  messageId   String
  companyId   Int
  body        String
  htmlBody    String?
  attachments Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  emails      Email[]
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@id([messageId, companyId])
  @@map("email_contents")
}

model ThreadSummary {
  threadId         String    @id @map("thread_id")
  companyId        Int
  summary          String
  keyPoints        Json?     @map("key_points")
  actionItems      Json?     @map("action_items")
  sentiment        String?
  participants     Json?
  processingTime   Int?      @map("processing_time")
  modelVersion     String?   @map("model_version")
  status           String    @default("pending")
  runpodJobId      String?   @map("runpod_job_id")
  submittedAt      DateTime? @map("submitted_at")
  completedAt      DateTime? @map("completed_at")
  lastSummarizedAt DateTime  @map("last_summarized_at")
  company          Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("thread_summaries")
}

model EmailDraft {
  id                   String       @id @default(uuid())
  accountId            String
  userId               Int
  companyId            Int
  toRecipients         Json         @map("to_recipients")
  ccRecipients         Json?        @map("cc_recipients")
  bccRecipients        Json?        @map("bcc_recipients")
  subject              String
  body                 String
  htmlBody             String?      @map("html_body")
  attachments          Json?
  replyToMessageId     String?      @map("reply_to_message_id")
  forwardFromMessageId String?      @map("forward_from_message_id")
  threadId             String?      @map("thread_id")
  contactIds           Json?        @map("contact_ids")
  dealIds              Json?        @map("deal_ids")
  accountEntityIds     Json?        @map("account_entity_ids")
  isScheduled          Boolean      @default(false) @map("is_scheduled")
  scheduledFor         DateTime?    @map("scheduled_for")
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")
  providerId           String?      @map("provider_id")
  remoteUid            String?      @map("remote_uid")
  from                 String?
  isTrashed            Boolean      @default(false) @map("is_trashed")
  account              EmailAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  company              Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@index([companyId])
  @@index([createdAt(sort: Desc)])
  @@index([isScheduled, scheduledFor])
  @@index([isTrashed])
  @@index([userId, isTrashed])
  @@map("email_drafts")
}

model Lead {
  id              Int           @id @default(autoincrement())
  companyId       Int
  name            String
  company         String?
  value           Float?
  stage           String        @default("OPEN")
  notes           String?
  userId          Int
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  closedAt        DateTime?
  history         LeadHistory[]
  user            User          @relation(fields: [userId], references: [id])
  companyRelation Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("leads")
}

model LeadHistory {
  id        Int      @id @default(autoincrement())
  leadId    Int
  companyId Int
  type      String
  text      String
  at        DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("lead_history")
}

model Pipeline {
  id          Int             @id @default(autoincrement())
  companyId   Int
  name        String
  description String?
  userId      Int
  isDefault   Boolean         @default(false)
  isActive    Boolean         @default(true)
  dealRotting Boolean         @default(false)
  rottenDays  Int             @default(30)
  ownerIds    Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  deals       Deal[]
  labels      Label[]
  stages      PipelineStage[]

  company Company @relation(fields: [companyId], references: [id])
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pipelines")
}

model PipelineStage {
  id          Int           @id @default(autoincrement())
  companyId   Int
  pipelineId  Int
  name        String
  orderIndex  Int
  rottenDays  Int?
  probability Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  historyFrom DealHistory[] @relation("HistoryFromStage")
  historyTo   DealHistory[] @relation("HistoryToStage")
  deals       Deal[]
  pipeline    Pipeline      @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([pipelineId, orderIndex])
  @@map("pipeline_stages")
}

model Deal {
  id                Int            @id @default(autoincrement())
  title             String
  companyId         Int
  value             Float?         @default(0)
  currency          String?        @default("USD")
  pipelineId        Int
  stageId           Int
  email             Json?
  phone             Json?
  description       String?
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  probability       Int            @default(0)
  userId            Int
  assignedTo        Int?
  status            String?        @default("OPEN")
  lostReason        String?
  lastActivityAt    DateTime?
  isRotten          Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  deletedAt         DateTime?
  archivedAt        DateTime?
  personId          Int?
  organizationId    Int?
  source            String?
  labelIds          Json?
  customFields      Json?
  ownerIds          Json?
  isVisibleToAll    Boolean        @default(true)
  calls             Call[]
  activities        DealActivity[]
  history           DealHistory[]

  // â”€â”€ Relations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedUser User?         @relation("DealAssigned", fields: [assignedTo], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])
  person       Person?       @relation(fields: [personId], references: [id])
  pipeline     Pipeline      @relation(fields: [pipelineId], references: [id])
  stage        PipelineStage @relation(fields: [stageId], references: [id])
  user         User          @relation("DealOwner", fields: [userId], references: [id], onDelete: Cascade)
  products     Product[]

  @@map("deals")
}

model DealHistory {
  id            Int       @id @default(autoincrement())
  dealId        Int
  userId        Int
  companyId     Int
  eventType     String
  fromValue     String?
  toValue       String?
  fromStageId   Int?
  toStageId     Int?
  stageDuration Float?
  description   String?
  metadata      String?
  createdAt     DateTime  @default(now())
  leftAt        DateTime?

  // â”€â”€ Relations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deal      Deal           @relation(fields: [dealId], references: [id], onDelete: Cascade)
  fromStage PipelineStage? @relation("HistoryFromStage", fields: [fromStageId], references: [id])
  toStage   PipelineStage? @relation("HistoryToStage", fields: [toStageId], references: [id])
  user      User           @relation(fields: [userId], references: [id])
  company   Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("deal_history")
}

model Product {
  id          Int       @id @default(autoincrement())
  dealId      Int
  userId      Int
  companyId   Int
  title       String
  price       Float
  quantity    Float
  tax         Float
  amount      Float
  discount    Float?
  billingDate DateTime?
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deal        Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("products")
}

model Label {
  id             Int           @id @default(autoincrement())
  value          String
  color          String?
  companyId      Int
  orderIndex     Int
  pipelineId     Int?
  userId         Int?
  organizationId Int?
  personId       Int?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])
  person         Person?       @relation(fields: [personId], references: [id])
  pipeline       Pipeline?     @relation(fields: [pipelineId], references: [id])
  user           User?         @relation(fields: [userId], references: [id])
  company        Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("labels")
}

model DealActivity {
  id           Int       @id @default(autoincrement())
  dealId       Int
  userId       Int
  companyId    Int
  activityType String
  subject      String?
  label        String?
  startDate    String?
  endDate      String?
  startTime    String?
  endTime      String?
  priority     String?
  busyFree     String?
  note         String?
  organization String?
  email        Json?
  files        Json?
  participants Json?
  deal         Json?
  persons      Json?
  mataData     Json?
  isDone       Boolean   @default(false)
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  dealRelation Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("deal_activities")
}

model Organization {
  id                Int       @id @default(autoincrement())
  companyId         Int
  name              String
  description       String?
  industry          String?
  website           String?
  status            String?   @default("active")
  emails            Json?
  phones            Json?
  annualRevenue     Float?
  numberOfEmployees Int?
  linkedinProfile   String?
  address           Json?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?
  deals             Deal[]
  labels            Label[]
  persons           Person[]
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("organisations")
}

model Person {
  id             Int           @id @default(autoincrement())
  companyId      Int
  firstName      String
  lastName       String?
  organizationId Int?
  emails         Json?
  phones         Json?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  calls          Call[]
  deals          Deal[]
  labels         Label[]
  userEmails     PersonEmail[]
  userPhones     PersonPhone[]
  organization   Organization? @relation(fields: [organizationId], references: [id])
  company        Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("persons")
}

model PersonEmail {
  id       Int    @id @default(autoincrement())
  personId Int
  email    String @unique
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@map("person_emails")
}

model PersonPhone {
  id       Int    @id @default(autoincrement())
  personId Int
  phone    String @unique
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@map("person_phones")
}

model Call {
  id               Int               @id @default(autoincrement())
  companyId        Int
  twilioCallSid    String?           @unique
  twilioAccountSid String?
  direction        String            @default("outbound")
  status           String            @default("initiated")
  fromNumber       String
  toNumber         String
  startTime        DateTime?
  answerTime       DateTime?
  endTime          DateTime?
  duration         Int               @default(0)
  ringDuration     Int?
  userId           Int
  contactId        Int?
  dealId           Int?
  leadId           Int?
  disposition      String?
  notes            String?
  summary          String?
  queueName        String?
  assignedAgentId  Int?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?
  events           CallEvent[]
  participants     CallParticipant[]
  recordings       CallRecording[]
  assignedAgent    User?             @relation("CallAssigned", fields: [assignedAgentId], references: [id])
  contact          Person?           @relation(fields: [contactId], references: [id])
  deal             Deal?             @relation(fields: [dealId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("calls")
}

model CallParticipant {
  id             Int       @id @default(autoincrement())
  callId         Int
  companyId      Int
  participantSid String?
  phoneNumber    String
  name           String?
  role           String    @default("callee")
  joinTime       DateTime?
  leaveTime      DateTime?
  muted          Boolean   @default(false)
  hold           Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  call           Call      @relation(fields: [callId], references: [id], onDelete: Cascade)
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("call_participants")
}

model CallRecording {
  id                  Int      @id @default(autoincrement())
  callId              Int
  companyId           Int
  recordingSid        String?  @unique
  recordingUrl        String?
  localFilePath       String?
  duration            Int      @default(0)
  fileSize            Int?
  channels            Int      @default(1)
  status              String   @default("processing")
  transcriptionSid    String?
  transcriptionText   String?
  transcriptionStatus String?
  transcriptionUrl    String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  call                Call     @relation(fields: [callId], references: [id], onDelete: Cascade)
  company             Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("call_recordings")
}

model EmailSyncState {
  id            String   @id @default(uuid())
  accountId     String
  companyId     Int
  folder        String
  lastSyncedUid Int      @default(0)
  updatedAt     DateTime @updatedAt
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([accountId, folder, companyId])
  @@map("email_sync_state")
}

model CallEvent {
  id          Int      @id @default(autoincrement())
  callId      Int
  companyId   Int
  eventType   String
  eventData   String?
  triggeredBy Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  call        Call     @relation(fields: [callId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [triggeredBy], references: [id])
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("call_events")
}

model Import {
  id                Int             @id @default(autoincrement())
  userId            Int
  companyId         Int
  entityType        String
  fileName          String
  fileFormat        String
  status            String          @default("pending")
  totalRows         Int             @default(0)
  processedRows     Int             @default(0)
  successCount      Int             @default(0)
  errorCount        Int             @default(0)
  skippedCount      Int             @default(0)
  duplicateHandling String          @default("skip")
  mapping           Json?
  filePath          String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  completedAt       DateTime?
  errorSummary      String?
  errors            ImportError[]
  records           ImportRecord[]
  staging           ImportStaging[]
  user              User            @relation(fields: [userId], references: [id])
  company           Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("imports")
}

model ImportError {
  id         Int      @id @default(autoincrement())
  importId   Int
  companyId  Int
  rowNumber  Int
  columnName String?
  value      String?
  errorType  String
  message    String
  createdAt  DateTime @default(now())
  import     Import   @relation(fields: [importId], references: [id], onDelete: Cascade)
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("import_errors")
}

model ImportRecord {
  id        Int      @id @default(autoincrement())
  importId  Int
  companyId Int
  entityId  Int
  action    String
  createdAt DateTime @default(now())
  import    Import   @relation(fields: [importId], references: [id], onDelete: Cascade)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("import_records")
}

model ImportTemplate {
  id         Int      @id @default(autoincrement())
  userId     Int
  companyId  Int
  name       String
  entityType String
  mapping    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("import_templates")
}

model ImportStaging {
  id        Int      @id @default(autoincrement())
  importId  Int
  companyId Int
  data      Json
  rowNumber Int
  createdAt DateTime @default(now())
  import    Import   @relation(fields: [importId], references: [id], onDelete: Cascade)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("import_staging")
}

model CalendarEvent {
  id            Int                 @id @default(autoincrement())
  companyId     Int
  userId        Int
  title         String
  description   String?
  startTime     DateTime
  endTime       DateTime
  location      String?
  isAllDay      Boolean             @default(false)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  deletedAt     DateTime?
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  company       Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  notifications EventNotification[]
  reminders     EventReminder[]
  shares        EventShare[]

  @@map("calendar_events")
}

model EventReminder {
  id                    Int                 @id @default(autoincrement())
  eventId               Int
  companyId             Int
  reminderMinutesBefore Int
  isDefault             Boolean             @default(false)
  createdAt             DateTime            @default(now())
  notifications         EventNotification[]
  event                 CalendarEvent       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("event_reminders")
}

model EventShare {
  id               Int           @id @default(autoincrement())
  eventId          Int
  companyId        Int
  sharedWithUserId Int
  participantType  String        @default("user")
  createdAt        DateTime      @default(now())
  event            CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  company          Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([eventId, sharedWithUserId, participantType])
  @@index([companyId])
  @@map("event_shares")
}

model EventNotification {
  id            Int           @id @default(autoincrement())
  eventId       Int
  companyId     Int
  reminderId    Int
  userId        Int
  userType      String        @default("user")
  scheduledAt   DateTime
  status        String        @default("pending")
  inAppSentAt   DateTime?
  emailSentAt   DateTime?
  failureReason String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  event         CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  reminder      EventReminder @relation(fields: [reminderId], references: [id], onDelete: Cascade)
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([eventId, reminderId, userId, userType])
  @@index([companyId])
  @@map("event_notifications")
}

model PricingTier {
  id            String         @id @default(uuid())
  name          String
  basePrice     Float
  currency      String         @default("EUR")
  features      Json?
  contractTerms String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  discountRules DiscountRule[]

  @@map("pricing_tiers")
}

model DiscountRule {
  id         String      @id @default(uuid())
  tierId     String
  type       String
  percentage Float
  conditions Json?
  createdAt  DateTime    @default(now())
  tier       PricingTier @relation(fields: [tierId], references: [id], onDelete: Cascade)

  @@map("discount_rules")
}

model BrandGuidelines {
  id                   String   @id @default("default")
  tone                 String   @default("professional")
  voiceCharacteristics Json?
  openingPhrases       Json?
  closingPhrases       Json?
  signatureTemplate    String?
  ctaPatterns          Json?
  avoidPhrases         Json?
  updatedAt            DateTime @default(now()) @updatedAt

  @@map("brand_guidelines")
}

model KnowledgeBase {
  id        Int      @id @default(autoincrement())
  companyId Int
  category  String
  topic     String
  content   String
  keywords  Json?
  updatedAt DateTime @default(now()) @updatedAt
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("knowledge_base")
}

model ClientProfile {
  id                String   @id @default(uuid())
  companyId         Int
  dealId            Int?
  personId          Int?
  organizationId    Int?
  requirements      Json?
  budgetMin         Float?
  budgetMax         Float?
  timeline          String?
  decisionMakers    Json?
  objections        Json?
  preferences       Json?
  relationshipStage String?
  maturityScore     Float?
  lastUpdated       DateTime @default(now()) @updatedAt
  createdAt         DateTime @default(now())
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("client_profiles")
}

model EmailSuggestion {
  id              String    @id @default(uuid())
  companyId       Int
  dealId          Int?
  personId        Int?
  subjectLine     String
  body            String
  htmlBody        String?
  emailType       String
  confidenceScore Float?
  reasoning       String?
  qualityScore    Float?
  issues          Json?
  status          String    @default("generated")
  userEdits       String?
  sentAt          DateTime?
  createdAt       DateTime  @default(now())
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("email_suggestions")
}

model Activity {
  id              String   @id @default(uuid())
  companyId       Int
  title           String
  description     String?
  type            String   @default("meeting")
  startAt         DateTime
  endAt           DateTime
  priority        String   @default("medium")
  status          String   @default("busy")
  isDone          Boolean  @default(false)
  location        String?
  videoCallLink   String?
  createdBy       Int
  assignedUserIds Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [createdBy], references: [id])
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("activities")
}

model StructuredKnowledgeBase {
  id                           Int      @id @default(autoincrement())
  companyId                    Int      @unique
  category_1_company_profile   Json?
  category_2_products_services Json?
  category_3_sales_process     Json?
  category_4_customers_markets Json?
  category_5_common_scenarios  Json?
  category_6_communication     Json?
  category_7_operations        Json?
  category_8_resources         Json?
  category_9_pricing           Json?
  version                      Int      @default(1)
  completion_percent           Float    @default(0)
  updated_at                   DateTime @default(now()) @updatedAt
  company                      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("structured_knowledge_base")
}

model StructuredKBVersion {
  id              String   @id @default(uuid())
  companyId       Int
  kbId            Int      @map("kb_id")
  version         Int
  fullKBSnapshot  Json     @map("full_kb_snapshot")
  changedSections Json     @map("changed_sections")
  changedBy       String?  @map("changed_by")
  changeTimestamp DateTime @default(now()) @map("change_timestamp")
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([kbId, version])
  @@index([companyId])
  @@map("structured_kb_versions")
}

model UserInvitation {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  companyId Int
  role      String   @default("user")
  invitedBy Int
  expiresAt DateTime
  status    String   @default("PENDING") // PENDING | ACCEPTED | EXPIRED | REVOKED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inviter User    @relation("InvitedBy", fields: [invitedBy], references: [id])

  @@unique([email, companyId, status])
  @@index([token])
  @@index([companyId])
  @@map("user_invitations")
}

model AuditLog {
  id         String   @id @default(uuid())
  companyId  Int
  userId     Int?
  action     String   // e.g., "USER_INVITED", "INVITATION_ACCEPTED"
  entityType String   // e.g., "UserInvitation"
  entityId   String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}
